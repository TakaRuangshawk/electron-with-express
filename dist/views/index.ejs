<!DOCTYPE html>
<%- include('include/head'); %>
	<html lang="en">

	<body>
		<h1>
			<%= title %>
		</h1>
		<p>Welcome to <%= title %>
		</p>
		<br />
		<p>Other Pages:</p>
		<a href="/pageTwo">Page Two</a>
		<br />
		<a href="/pageThree">Page Three</a>
		<br />
		<a href="/pageFour">Page Four</a>
		<form id="messageForm">
			<input type="text" id="messageInput" placeholder="Enter your message">
            <button type="button" onclick="sendMessage('sendlog : ' + document.getElementById('messageInput').value)">Send Message</button>

		</form>
        <button class ="button-19" id="fetchButton" style="position: absolute; top: 758px;left: 112px;background-color: white;border: 0;padding: 0;">
            <img id="fetchedImage" src="./pic/btn_printTotal.jpg" alt="Get Banknote& Print Total" style="width: 100%; height: auto;    border-radius: 30px;">
        </button>
        <button class="button-19" id="fetchButton2" style="position: absolute; top: 758px;left: 530px;background-color: white;border: 0;padding: 0;">
            <img id="fetchedImage" src="./pic/btn_replenishCash.jpg" alt="Get Banknote& Print Total" style="width: 100%; height: auto;    border-radius: 30px;">
        </button>
        <div id="htmlContent"></div>
        <div id="tableContainer"></div>

	</body>
    <script>
    document.getElementById('fetchButton').addEventListener('click', function() {
        // Fetch data from the initial endpoint
        fetch('https://localhost:5001/lpk/api/v1/kiosk/banknote', {
          method: 'GET',
          headers: {
            'Accept': '*/*',
            'Content-Type': 'application/json',
            'ApiKey': '11d976dd-32b4-4449-b4a1-ed27a01014f2'
          },
        })
          .then(response => response.json()) // Convert response to JSON
          .then(data => {
            document.getElementById('htmlContent').innerHTML = JSON.stringify(data, null, 2);
            console.log(data);
            const table = createTable(data);
            document.getElementById('tableContainer').innerHTML = ''; // Clear previous table
            document.getElementById('tableContainer').appendChild(table);
            // Create the payload for the POST request
            const postData = {
              device_name: data.device_name,
              banknote: data.banknote.map(note => ({
                note_name: note.note_name,
                value: note.value,
                note: note.note,
                sum: note.sum
              })),
              total_bank_note: data.banknote.length,
              total_amount: data.banknote.reduce((total, note) => total + note.value * note.note, 0),
              update: new Date().toISOString()
            };
            console.log(postData);
            // Send the POST request
            fetch('https://localhost:5001/lpk/api/v1/kiosk/print_total_banknote', {
              method: 'POST',
              headers: {
                'Accept': '*/*',
                'Content-Type': 'application/json',
                'ApiKey': '11d976dd-32b4-4449-b4a1-ed27a01014f2'
              },
              body: JSON.stringify(postData)
            })
            .then(response => response.json())
            .then(result => {
              console.log('Success:', result);
             
              document.getElementById('htmlContent').innerHTML = JSON.stringify(result, null, 2);
            })
            .catch(error => console.error('Error:', error));
          })
          .catch(error => console.error('Error:', error));
    });
    document.getElementById('fetchButton2').addEventListener('click', function() {
        fetch('https://localhost:5001/lpk/api/v1/kiosk/set_banknote', {
          method: 'POST',
          headers: {
            'Accept': '*/*',
            'Content-Type': 'application/json',
            'ApiKey': '11d976dd-32b4-4449-b4a1-ed27a01014f2'
          },
          body: JSON.stringify({
            "device_name": "YourDeviceName",
            "banknote": [
              { "note_name": "20", "value": 0, "note": 0 },
              { "note_name": "50", "value": 0, "note": 0 },
              { "note_name": "100", "value": 0, "note": 0 },
              { "note_name": "500", "value": 0, "note": 0 },
              { "note_name": "1000", "value": 0, "note": 0 }
            ]
          })
        })
        .then(response => response.json())
        .then(data => {
          const table = createTable(data);
          document.getElementById('tableContainer').innerHTML = ''; // Clear previous table
          document.getElementById('tableContainer').appendChild(table);
          console.log('Success:', data);
        })
        .catch(error => {
          console.error('Error:', error);
        });

    });
    </script>
	<script>
    function createTable(data) {
      const table = document.createElement('table');
      const headerRow = table.insertRow();

      // Define the desired header order
      const headerOrder = ['note_name', 'note', 'sum'];
      const headerNames = {
        note_name: 'Banknotes',
        note: 'PCS.',
        sum: 'Amount  '
      };
      // Create header cells in the defined order
      headerOrder.forEach(key => {
        const headerCell = document.createElement('th');
        headerCell.textContent = headerNames[key];
        headerRow.appendChild(headerCell);
      });
    
       // Create data rows
      data.banknote.forEach(note => {
        const row = table.insertRow();
        headerOrder.forEach(key => {
          const cell = row.insertCell();
          cell.textContent = key === 'sum' ? (note.value * note.note) : note[key];
        });
      });    
      return table;
    }
        function sendMessage(message) {
            var messageInput = message;
            console.log(messageInput);
            fetch('http://127.0.0.1:3000/sendMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ message: messageInput })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Message sent:', data);
            })
            .catch(error => {
                console.error('Error sending message:', error);
            });
        }
    </script>
	</html>